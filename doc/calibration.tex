\documentclass[12pt,a4paper,bibliography=totocnumbered,listof=totocnumbered]{scrartcl}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{fancyhdr}
\usepackage{tabularx}
\usepackage{geometry}
\usepackage{setspace}

\usepackage{listings}
\author{Dominik Schmidt}
\title{Calibration documentation}

\lstset{basicstyle=\footnotesize, captionpos=b, breaklines=true, showstringspaces=false, tabsize=2, frame=lines, numbers=left, numberstyle=\tiny, xleftmargin=2em, framexleftmargin=2em}
\makeatletter
\def\l@lstlisting#1#2{\@dottedtocline{1}{0em}{1em}{\hspace{1,5em} Lst. #1}{#2}}
\makeatother

\geometry{a4paper, top=27mm, left=30mm, right=20mm, bottom=35mm, headsep=10mm, footskip=12mm}


\begin{document}
\maketitle
\section{Introduction}
The aim of this document is to describe each step of the calibration that is done in the cake module.
Please note that this document is unfinished may change at any time.
Also note that some of the features described here might not be implemented yet. 
ALSO note that until now, only LIF parameters are supported.

\section{Parameter types}
Since the hardware has different types of parameters, we need to define different parameter spaces and transformations.
The aim of a calibration is to accurately determine these transformations.

We concluded that we should define four different parameter spaces (note that the two examples given for each parameter space are corresponding):
\begin{itemize}
\item Biological parameters (Bio)
\subitem $\rightarrow$ pyNN parameters, for example $v_{rest}$ or $tau_m$
\item Hardware parameters (HW)
\subitem $\rightarrow$ Parameters that are measured on the hardware, for example $E_l$ or $g_l$
\item Hardware control parameters (HC)
\subitem $\rightarrow$ Parameters that control the hardware, for example $E_\text{l}$ or $I_\text{gl}$
\subitem $\rightarrow$ Found in pyhalbe.HICANN.neuron\_parameters and .. .shared\_parameters
\item Floating gate values (DAC)
\subitem $\rightarrow$ Discreet floating gate values between 0 and 1023.
\subitem $\rightarrow$ Voltages are calculated by $DAC * \frac{1800 mV}{1023}$
\subitem $\rightarrow$ Currents are calculated by $DAC * \frac{2500 nA}{1023}$
\end{itemize}
 
Calibration should be applied as the \textbf{last} step (to DAC values) in order to make it independend on the type of user input.
Until now, calibtic only supports this last step and it does not properly support transformations between each of these parameter spaces.
This missing feature will be implented in calibtic soon.

\section{Calibration}
Calibration steps are listed in the order in which they should be run.
For each parameter, you will find a description of what it does, how it is measured, what the calibration does to it and everything else that is worth noting.

The run\_calibration tool in the pycake/bin/ folder will calibrate all working parameters.
To configure the calibration, you have to edit parameters.py to match whatever you want to calibrate or measure.
There you can edit the calibrated ranges, step length and number of repetitions (which will increase accuracy but also linearly increase experiment time).
After calibration of a parameter, you should keep that variable within the range in which you calibrated - outside of the range, the accuracy can decrease.

\subsection{Readout shift}
The neuron is connected to the readout amplifier via an operational amplifier.
This amplifier has a different offset for each neuron, which has to be measured in the first step.
For this purpose, we make use of the fact that one value of $V_\text{reset}$ is applied to a whole block of neurons, so that there should be no variation between this block.
First, $V_\text{reset}$ is measured for all neurons and averaged four times over each block.
This mean $V_\text{reset}$ is considered to be the "real" $V_\text{reset}$.
The readout shift is then calculated by taking each neuron's mean variation from that "real" value.
This shift is stored in calibtic as the 21st parameter.

\subsection{$E_\text{syni}$ and $E_\text{synx}$}
$E_\text{syni}$ and $E_\text{synx}$ are the synaptic reversal potentials. 
These voltages are applied at the $OTA_0$ in the synaptic input circuit (see figure \ref{figure:synapse}). 
Their pyNN-counterparts are e\_rev\_I and e\_rev\_E.

\begin{figure}[h]
\begin{center}
\includegraphics[width=0.5\textwidth]{images/synapse.png}
\caption{Synapse circuit. $E_{syn}$ is applied to OTA1}
\label{figure:synapse}
\end{center}
\end{figure}

\subsubsection*{Measurement}
The synaptic reversal potentials are measured using leakage currents of the synaptic input circuit.
Since inhibitory and excitatory input circuits are identical, I will only describe the measurement once.

Ideally, when no spike input is present, there should be no leakage current through $OTA_0$.
However, due to imperfections in the manufacturing process, these leakages cannot avoided.
Here, we make use of them by turning off all other conductances in the neuron circuit.
With the synaptic input being the only remaining conductance, the membrane potential will approach the synaptic reversal potential.
This can easily be measured with the ADC, thus giving an approximation of the reversal potential.

\subsection{$E_\text{l}$}
$E_\text{l}$ is the membrane leakage potential that determines where the membrane potential should stay when no input is given at all.
It is applied at the leakage OTA (see figure \ref{figure:leakage}).
The corresponding pyNN parameter is the resting potential $V_\text{rest}$.

\begin{figure}[h]
\begin{center}
\includegraphics[width=0.3\textwidth]{images/leakage.png}
\caption{Synapse circuit. $E_{syn}$ is applied to OTA1}
\label{figure:leakage}
\end{center}
\end{figure}

While calibrating, the synaptic reversal potentials are set symmetrically around $E_\text{l}$.
In all following calibrations, the synaptic reversal potentials are also set symmetrically around the calibrated $E_\text{l}$.

\subsubsection*{Measurement}
$E_\text{l}$ is measured by turning on all conductances that will later be turned on while experiments are run.
That way, it is ensured that we calibrate an effective resting potential that balances the unwanted leakage currents.
Then, without any input, the membrane potential approaches a value which will be considered as $E_\text{l}$.

\subsection{$V_\text{t}$}
$V_\text{t}$ is the voltage at which a spike is initiated.
This voltage corresponts to the pyNN parameter $V_\text{thresh}$ in a LIF model.

\subsubsection*{Measurement}
To measure $V_\text{t}$, the resting potential $E_\text{l}$ is set above the threshold so that the neuron is spiking all the time.
Then, the maximum of the trace is measured and considered to be $V_\text{t}$.
There was a discussion whether it would be more exact to take the mean value of all the local maxima instead of one maximum for the whole curve.
This idea was rejected mainly because this would underestimate $V_\text{t}$ as the ADC does not always hit the exact maximum of the voltage trace, but measures mostly a little too early or a little too late.

\subsection{$V_\text{reset}$}
After a spike, the membrane potential is set to $V_\text{reset}$.
This parameter corresponds to the pyNN parameter $V_\text{reset}$.

Since this parameter is a shared parameter, it can not be set for each neuron individually but only for blocks of 128 neurons.
In this case, the calibration reduces block-to-block variation.

\subsubsection*{Measurement}
$V_\text{reset}$ is measured by chosing a long $\tau_{ref}$ time.
Then, the neuron is set to be always spiking.
An algorithm determines the 

\end{document}